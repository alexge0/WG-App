<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Putz-Commander</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* Helles, freundliches Design */
        body { 
            padding: 10px; 
            background-color: #f0f2f5; 
            color: #1d1d1d;
        }
        
        h1 { 
            text-align: center; 
            font-size: 1.5rem; 
            margin-bottom: 20px; 
            color: #333;
        }

        .card { 
            background-color: #ffffff; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border: 1px solid #e0e0e0;
        }

        .score-display { 
            font-size: 2.5em; 
            font-weight: bold; 
            text-align: center; 
            color: #2d3436; 
        }

        .task-title { 
            font-size: 1.3em; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #000;
        }

        .deadline { 
            font-size: 0.9em; 
            font-weight: bold;
            margin-bottom: 10px; 
        }
        
        /* Fortschrittsbalken Hintergrund heller */
        .progress-container { 
            width: 100%; 
            background-color: #e0e0e0; 
            border-radius: 10px; 
            height: 12px; 
            margin-top: 10px; 
            overflow: hidden; 
        }
        .progress-bar { height: 100%; transition: width 0.5s; }

        /* Angepasste Farben f√ºr bessere Lesbarkeit auf Wei√ü */
        .color-good { color: #00b894; }
        .bg-good { background-color: #00b894; }
        
        .color-warn { color: #e17055; }
        .bg-warn { background-color: #e17055; }
        
        .color-bad { color: #d63031; }
        .bg-bad { background-color: #d63031; }

        /* Namen √ºber dem Score */
        .score-label {
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8em;
            color: #636e72;
            font-weight: bold;
        }

        button.danger { background-color: #d63031; border: none; opacity: 0.8; font-size: 0.8rem; margin-top: 10px;}
        button.action-btn { background-color: #0984e3; border: none; width: auto; padding: 8px 20px; font-size: 0.9em; margin-bottom: 0; }
    </style>
</head>
<body>

    <main class="container">
        <h1>‚ôæÔ∏è WG Putz-Loop</h1>

        <article class="card">
            <header>üèÜ Highscore</header>
            <div class="grid">
                <div style="text-align: center;">
                    <div class="score-label">Alex</div>
                    <div id="score-me" class="score-display">-</div>
                </div>
                <div style="text-align: center;">
                    <div class="score-label">Fred</div>
                    <div id="score-him" class="score-display">-</div>
                </div>
            </div>
        </article>

        <div id="task-container">
            <p aria-busy="true" style="color:#666; text-align:center;">Lade Putzplan...</p>
        </div>

        <details>
            <summary style="color:#666; font-size:0.9em;">Einstellungen</summary>
            <button class="danger" onclick="resetDatabase()">‚ö†Ô∏è Neustart (Reset)</button>
        </details>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- DEINE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- PUNKTE REGELN ---
        function calculatePoints(daysPassed) {
            if (daysPassed < 4) return 15;
            if (daysPassed < 6) return 10;
            if (daysPassed < 7) return 5;
            if (daysPassed < 8) return 2;
            return -5;
        }

        // --- UI RENDERING ---
        function renderUserCard(userId, userName, userData) {
            const lastCleaned = userData.lastCleaned.toDate(); 
            const now = new Date();
            
            // Berechne exakte Tage
            const diffTime = now - lastCleaned;
            const daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const pointsNow = calculatePoints(daysPassed);
            
            // Ampel-Logik
            let statusColor = "color-good";
            let bgColor = "bg-good";
            let statusText = "Alles im gr√ºnen Bereich";
            let borderColor = "#00b894"; // Gr√ºn f√ºr Rand

            if(daysPassed >= 4) { 
                statusColor = "color-warn"; 
                bgColor = "bg-warn"; 
                statusText = "Zeit l√§uft ab..."; 
                borderColor = "#e17055";
            }
            if(daysPassed >= 7) { 
                statusColor = "color-bad"; 
                bgColor = "bg-bad"; 
                statusText = "√úBERF√ÑLLIG!"; 
                borderColor = "#d63031";
            }

            // Fortschrittsbalken
            let progress = (daysPassed / 7) * 100;
            if(progress > 100) progress = 100;

            let html = `<article class="card" style="border-left: 6px solid ${borderColor}">`;
            html += `<header style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">`;
            html += `<span style="font-size:1.1em; color:#333;">üë§ <b>${userName}</b></span>`;
            html += `<span style="font-size:0.8em; color:#888;">Seit ${daysPassed} Tagen</span>`;
            html += `</header>`;
            
            html += `<div class="task-title">${userData.currentTask}</div>`;
            html += `<div class="deadline ${statusColor}">${statusText}</div>`;
            
            html += `<div class="progress-container"><div class="progress-bar ${bgColor}" style="width: ${progress}%"></div></div>`;
            
            html += `<div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span style="color:#555;">Punkte m√∂glich: <b class="${statusColor}">${pointsNow}</b></span>`;
            
            html += `<button class="action-btn" onclick="window.completeTask('${userId}', ${pointsNow}, '${userData.currentTask}')">Erledigt ‚úÖ</button>`;
            html += `</div>`;
            
            html += `</article>`;
            return html;
        }

        // --- HAUPTFUNKTION ---
        function loadDashboard() {
            onSnapshot(doc(db, "wg_app", "state_v2"), (docSnap) => {
                if (!docSnap.exists()) {
                    document.getElementById('task-container').innerHTML = "<p style='text-align:center;'>Datenbank leer. Bitte unten auf 'Neustart' klicken!</p>";
                    return;
                }

                const data = docSnap.data();
                
                document.getElementById('score-me').innerText = data.users.me.score;
                document.getElementById('score-him').innerText = data.users.him.score;

                let html = "";
                // Hier werden jetzt Alex und Fred angezeigt
                html += renderUserCard("me", "Alex", data.users.me);
                html += renderUserCard("him", "Fred", data.users.him);
                document.getElementById('task-container').innerHTML = html;
            });
        }

        // --- AKTIONEN ---
        window.completeTask = async (userId, pointsToAdd, currentTaskName) => {
            if(!confirm(`Aufgabe "${currentTaskName}" wirklich erledigt?`)) return;

            const docRef = doc(db, "wg_app", "state_v2");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const currentUserData = data.users[userId];
            const nextTask = (currentTaskName === "Bad putzen") ? "K√ºche putzen" : "Bad putzen";
            const newScore = currentUserData.score + pointsToAdd;

            const newUserData = {
                score: newScore,
                currentTask: nextTask,
                lastCleaned: Timestamp.now() 
            };

            await updateDoc(docRef, {
                [`users.${userId}`]: newUserData
            });
        };

        // --- DATABASE INIT ---
        async function initDatabase() {
            console.log("Erstelle Datenbank Struktur...");
            await setDoc(doc(db, "wg_app", "state_v2"), {
                users: {
                    me: { score: 0, currentTask: "Bad putzen", lastCleaned: Timestamp.now() },
                    him: { score: 0, currentTask: "K√ºche putzen", lastCleaned: Timestamp.now() }
                }
            });
        }

        window.resetDatabase = async () => {
            if(confirm("Alles auf Anfang setzen? Punkte werden gel√∂scht!")) {
                await initDatabase();
                location.reload();
            }
        }

        loadDashboard();
    </script>
</body>
</html>
