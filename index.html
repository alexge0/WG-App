<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Zentrale</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* --- GLOBAL DESIGN --- */
        body { padding: 10px; background-color: #f0f2f5; color: #1d1d1d; min-height: 100vh; padding-bottom: 80px;}
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; color: #333; }
        
        /* Views Management */
        .app-view { display: none; }
        .app-view.active { display: block; }

        /* --- DASHBOARD STYLES --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        .module-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
            cursor: pointer; transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .module-card:active { transform: scale(0.98); }
        
        .module-icon { font-size: 2em; margin-bottom: 10px; display: block; }
        .module-title { font-weight: bold; font-size: 1.2em; margin-bottom: 5px; }
        .widget-content { font-size: 0.9em; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .widget-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .module-card.disabled { opacity: 0.6; cursor: default; filter: grayscale(1); }

        /* --- UI COMPONENTS --- */
        .back-header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; font-size: 1.5rem; padding: 0 10px 0 0; color: #333; width: auto; }
        
        .card { background-color: #ffffff; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .score-display { font-size: 2.5em; font-weight: bold; text-align: center; color: #2d3436; }
        .score-label { text-transform: uppercase; letter-spacing: 1px; font-size: 0.8em; color: #636e72; font-weight: bold; }
        .task-title { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; color: #000; }
        .deadline { font-size: 0.9em; font-weight: bold; margin-bottom: 10px; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 12px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
        .stat-val { font-weight: bold; }

        /* SHOPPING LIST STYLES */
        .shop-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .shop-input-group input { margin-bottom: 0; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .shop-item:last-child { border-bottom: none; }
        .check-btn { 
            width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; background: white; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; color: white;
        }
        .check-btn:active { background-color: #eee; }

        /* Navigation unten */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { text-align: center; font-size: 0.9em; color: #888; cursor: pointer; flex: 1; }
        .nav-item.active { color: #0984e3; font-weight: bold; }

        /* Farben */
        .color-good { color: #00b894; } .bg-good { background-color: #00b894; }
        .color-warn { color: #e17055; } .bg-warn { background-color: #e17055; }
        .color-bad { color: #d63031; } .bg-bad { background-color: #d63031; }

        .sub-view { display: none; }
        .sub-view.active { display: block; padding-bottom: 80px; }
        
        button.action-btn { background-color: #0984e3; border: none; width: auto; padding: 8px 20px; font-size: 0.9em; margin-bottom: 0; }
        button.danger { background-color: #d63031; border: none; opacity: 0.8; font-size: 0.8rem; margin-top: 10px;}
        button.add-btn { background-color: #00b894; border: none; width: auto; margin-bottom: 0; }
    </style>
</head>
<body>

    <main class="container">
        
        <div id="view-main-menu" class="app-view active">
            <h1>üè† WG Zentrale</h1>
            <div class="dashboard-grid">
                
                <div class="module-card" onclick="openModule('cleaning')">
                    <span class="module-icon">üßπ</span>
                    <div class="module-title">Putzplan</div>
                    <div class="widget-content" id="dashboard-summary">Lade...</div>
                </div>

                <div class="module-card" onclick="openModule('shopping')">
                    <span class="module-icon">üõí</span>
                    <div class="module-title">Einkaufsliste</div>
                    <div class="widget-content" id="shop-widget-summary">Lade...</div>
                </div>

                <div class="module-card" onclick="openModule('finance')">
                    <span class="module-icon">üí∏</span>
                    <div class="module-title">Finanzen</div>
                    <div class="widget-content" id="fin-widget-summary">Lade...</div>
                </div>

            </div>
        </div>

        <div id="view-cleaning" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Putz-Planer</h2>
            </div>

            <div id="sub-dashboard" class="sub-view active">
                <article class="card">
                    <header>üèÜ Highscore</header>
                    <div class="grid">
                        <div style="text-align: center;">
                            <div class="score-label">Alex</div>
                            <div id="score-me" class="score-display">-</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="score-label">Fred</div>
                            <div id="score-him" class="score-display">-</div>
                        </div>
                    </div>
                </article>
                <div id="task-container">Lade Daten...</div>
            </div>

            <div id="sub-stats" class="sub-view">
                <article class="card">
                    <header>üìä Analyse: Alex</header>
                    <div id="stats-alex">Lade...</div>
                </article>
                <article class="card">
                    <header>üìä Analyse: Fred</header>
                    <div id="stats-fred">Lade...</div>
                </article>
                <article class="card">
                    <header>üìú Verlauf</header>
                    <ul id="history-list" style="font-size: 0.8em; padding-left: 20px;"></ul>
                </article>
                
                <details style="margin-top: 30px;">
                    <summary style="color:#666; font-size:0.9em;">Admin Putzplan</summary>
                    <button class="danger" onclick="resetCleaning()">üßπ Nur Putzdaten resetten</button>
                </details>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" onclick="switchSubTab('dashboard', this)">
                    <span style="display:block; font-size:1.5em;">üßπ</span> Plan
                </div>
                <div class="nav-item" onclick="switchSubTab('stats', this)">
                    <span style="display:block; font-size:1.5em;">üìà</span> Stats
                </div>
            </div>
        </div>
        
        <div id="view-finance" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">üí∞ WG-Kasse</h2>
            </div>

            <article class="card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border:none;">
                <header style="border-bottom: 1px solid rgba(255,255,255,0.2);">Monatliche Belastung</header>
                <div style="font-size: 2.5em; font-weight: bold; text-align: center;">
                    <span id="fin-total">0</span> ‚Ç¨
                </div>
                <div class="grid" style="margin-top:15px; text-align:center; font-size:0.9em;">
                    <div>
                        <small style="opacity:0.8">Alex (55%)</small><br>
                        <b id="fin-share-me">0 ‚Ç¨</b>
                    </div>
                    <div>
                        <small style="opacity:0.8">Fred (45%)</small><br>
                        <b id="fin-share-him">0 ‚Ç¨</b>
                    </div>
                </div>
            </article>

            <article class="card">
                <header>Fixkosten Aufstellung</header>
                <div id="cost-list">Lade Daten...</div>
                <small style="display:block; text-align:center; color:#888; margin-top:10px;">* GEZ wird anteilig berechnet</small>
            </article>

            <article class="card">
                <header>üìú Preisentwicklung</header>
                <ul id="fin-history-list" style="font-size: 0.8em; padding-left: 20px; color:#666;"></ul>
            </article>

            <details style="margin-top: 30px;">
                <summary style="color:#666; font-size:0.9em;">Admin Finanzen</summary>
                <button class="danger" onclick="resetFinance()">üí∏ Nur Finanzen resetten</button>
            </details>
        </div>

        <div id="view-shopping" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Einkaufsliste</h2>
            </div>

            <article class="card">
                <div class="shop-input-group">
                    <input type="text" id="shop-input" placeholder="Was fehlt? (z.B. Milch)">
                    <button class="add-btn" onclick="window.addShopItem()">+</button>
                </div>
                
                <div id="shopping-list-container">
                    <p style="text-align:center; color:#999;">Alles da! K√ºhlschrank ist voll.</p>
                </div>
            </article>

            <article class="card">
                <header>üõí Einkaufs-Logbuch</header>
                <ul id="shop-log-list" style="font-size: 0.8em; padding-left: 20px; color:#666;">
                    <li>Lade...</li>
                </ul>
            </article>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="danger" onclick="resetShopping()" style="width: auto; font-size: 0.8em;">üõí Reset (Liste leeren)</button>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVIGATION ---
        window.openModule = (moduleId) => {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + moduleId).classList.add('active');
        };

        window.switchSubTab = (subId, element) => {
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('sub-' + subId).classList.add('active');
            element.classList.add('active');
        };

        // --- HELPER ---
        function calculatePoints(daysPassed) {
            if (daysPassed < 4) return 15;
            if (daysPassed < 6) return 10;
            if (daysPassed < 7) return 5;
            if (daysPassed < 8) return 2;
            return -5;
        }

        function getStatusInfo(lastCleanedDate) {
            const now = new Date();
            const daysPassed = Math.floor((now - lastCleanedDate.toDate()) / (1000 * 60 * 60 * 24));
            let color = "#00b894"; // Gr√ºn
            if(daysPassed >= 4) color = "#e17055"; // Orange
            if(daysPassed >= 7) color = "#d63031"; // Rot
            return { days: daysPassed, color: color };
        }

        // --- RENDERERS ---
        function renderDashboardWidget(data) {
            // Putzen
            const alexStatus = getStatusInfo(data.users.me.lastCleaned);
            const fredStatus = getStatusInfo(data.users.him.lastCleaned);
            document.getElementById('dashboard-summary').innerHTML = `
                <div class="widget-row">
                    <span>Alex: ${data.users.me.currentTask}</span>
                    <span><span class="status-dot" style="background:${alexStatus.color}"></span> ${alexStatus.days}T</span>
                </div>
                <div class="widget-row">
                    <span>Fred: ${data.users.him.currentTask}</span>
                    <span><span class="status-dot" style="background:${fredStatus.color}"></span> ${fredStatus.days}T</span>
                </div>
            `;

            // Finanzen
            if(data.finance) {
                 let total = 0;
                 Object.values(data.finance.costs).forEach(c => {
                    let val = c.val;
                    if(c.val === 55.08) val = 18.36; // GEZ fix
                    total += val;
                 });
                 document.getElementById('fin-widget-summary').innerText = `Gesamt: ${total.toFixed(0)}‚Ç¨ / Monat`;
            } else {
                document.getElementById('fin-widget-summary').innerText = "Einrichtung n√∂tig";
            }

            // Einkaufsliste
            if(data.shopping) {
                const count = data.shopping.list.length;
                const text = count === 0 ? "Alles da ‚úÖ" : `<b>${count} Teile</b> fehlen`;
                document.getElementById('shop-widget-summary').innerHTML = text;
            } else {
                document.getElementById('shop-widget-summary').innerText = "Einrichtung n√∂tig";
            }
        }

        function renderUserCard(userId, userName, userData) {
            const status = getStatusInfo(userData.lastCleaned);
            const pointsNow = calculatePoints(status.days);
            
            let statusText = "Alles gut";
            let borderColor = status.color;
            if(status.days >= 4) statusText = "Zeit l√§uft ab...";
            if(status.days >= 7) statusText = "√úBERF√ÑLLIG!";
            let progress = (status.days / 7) * 100;
            if(progress > 100) progress = 100;

            let html = `<article class="card" style="border-left: 6px solid ${borderColor}">`;
            html += `<header style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">`;
            html += `<span style="font-size:1.1em; color:#333;">üë§ <b>${userName}</b></span>`;
            html += `<span style="font-size:0.8em; color:#888;">Seit ${status.days} Tagen</span>`;
            html += `</header>`;
            html += `<div class="task-title">${userData.currentTask}</div>`;
            html += `<div class="deadline" style="color:${borderColor}">${statusText}</div>`;
            html += `<div class="progress-container"><div class="progress-bar" style="width: ${progress}%; background-color:${borderColor}"></div></div>`;
            html += `<div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span style="color:#555;">Punkte: <b style="color:${borderColor}">${pointsNow}</b></span>`;
            html += `<button class="action-btn" onclick="window.completeTask('${userId}', ${pointsNow}, '${userData.currentTask}', ${status.days})">Erledigt ‚úÖ</button>`;
            html += `</div>`;
            html += `</article>`;
            return html;
        }

        function calculateStats(history, userId) {
            const userHistory = history.filter(h => h.user === userId);
            if (userHistory.length === 0) return `<div style="text-align:center; color:#999;">Noch keine Daten</div>`;
            const totalCleans = userHistory.length;
            const totalDays = userHistory.reduce((sum, entry) => sum + entry.daysTaken, 0);
            const avgDays = (totalDays / totalCleans).toFixed(1);
            const lates = userHistory.filter(h => h.daysTaken >= 7).length;
            const fastest = Math.min(...userHistory.map(h => h.daysTaken));
            return `
                <div class="stat-row"><span>üßπ Anzahl:</span> <span class="stat-val">${totalCleans}</span></div>
                <div class="stat-row"><span>‚è±Ô∏è √ò Dauer:</span> <span class="stat-val">${avgDays} Tage</span></div>
                <div class="stat-row"><span>üê¢ Versp√§tet:</span> <span class="stat-val" style="color:${lates > 0 ? '#d63031' : 'inherit'}">${lates}x</span></div>
                <div class="stat-row"><span>üèéÔ∏è Rekord:</span> <span class="stat-val">${fastest} Tage</span></div>
            `;
        }

        // --- FINANZ LOGIK ---
        function renderFinance(data) {
            if(!data.finance) return; 
            const costs = data.finance.costs; 
            const history = data.finance.history || [];
            let monthlyTotal = 0;
            let listHtml = '<table style="width:100%; font-size:0.9em;">';

            for (const [key, item] of Object.entries(costs)) {
                const isGEZ = key === 'gez';
                const displayVal = item.val; 
                const calculationVal = isGEZ ? (item.val / 3) : item.val;
                monthlyTotal += calculationVal;

                const labels = { rent: "Kaltmiete", gas: "Gasabschlag", strom: "Strom", gez: "GEZ (Rundfunk)", internet: "Internet" };
                const label = labels[key] || key;
                
                let dateText = `Abb: ${item.day}. des Monats`;
                if(isGEZ) dateText = `Abb: ${item.day}. (Jan/Apr/Jul/Okt)`;
                let valText = `${displayVal.toFixed(2)} ‚Ç¨`;
                if(isGEZ) valText += ` <span style="font-size:0.7em; color:#888;">/ Q</span>`;

                listHtml += `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px 0;">
                            <b>${label}</b><br>
                            <small style="color:#888;">${dateText}</small>
                        </td>
                        <td style="text-align:right;">
                            <b>${valText}</b><br>
                            <a href="#" onclick="window.editCost('${key}', ${item.val})" style="font-size:0.8em;">Bearbeiten</a>
                        </td>
                    </tr>
                `;
            }
            listHtml += '</table>';
            document.getElementById('fin-total').innerText = monthlyTotal.toFixed(2);
            document.getElementById('cost-list').innerHTML = listHtml;
            document.getElementById('fin-share-me').innerText = (monthlyTotal * 0.55).toFixed(2) + " ‚Ç¨";
            document.getElementById('fin-share-him').innerText = (monthlyTotal * 0.45).toFixed(2) + " ‚Ç¨";

            const recentHistory = [...history].reverse().slice(0, 5);
            let histHtml = "";
            recentHistory.forEach(h => {
                histHtml += `<li><b>${h.date}</b>: ${h.category} ge√§ndert (${h.oldVal}‚Ç¨ ‚ûù ${h.newVal}‚Ç¨)</li>`;
            });
            document.getElementById('fin-history-list').innerHTML = histHtml || "<li>Keine √Ñnderungen bisher</li>";
        }

        window.editCost = async (key, currentVal) => {
            let msg = `Neuer Betrag f√ºr ${key}?`;
            if(key === 'gez') msg += " (Bitte Quartalssumme eingeben!)";
            const newValStr = prompt(msg, currentVal);
            if(newValStr === null) return; 
            const newVal = parseFloat(newValStr.replace(',', '.'));
            if(isNaN(newVal)) return alert("Bitte eine Zahl eingeben!");
            if(newVal === currentVal) return;

            const docRef = doc(db, "wg_app", "state_v3");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();
            const now = new Date();
            const dateStr = now.toLocaleDateString('de-DE');
            const historyEntry = { date: dateStr, category: key, oldVal: currentVal, newVal: newVal };
            const newCosts = { ...data.finance.costs };
            newCosts[key].val = newVal;
            const newHistory = data.finance.history ? [...data.finance.history, historyEntry] : [historyEntry];
            await updateDoc(docRef, { "finance.costs": newCosts, "finance.history": newHistory });
        };

        // --- SHOPPING LOGIK ---
        function renderShopping(data) {
            if(!data.shopping) return;
            const list = data.shopping.list || [];
            const log = data.shopping.log || [];

            // Liste
            let html = "";
            list.forEach((item, index) => {
                html += `
                <div class="shop-item">
                    <span>${item.name}</span>
                    <div class="check-btn" onclick="window.buyItem(${index}, '${item.name}')">‚úî</div>
                </div>
                `;
            });
            if(list.length === 0) html = `<p style="text-align:center; color:#aaa; margin-top:20px;">Nichts zu kaufen üçª</p>`;
            document.getElementById('shopping-list-container').innerHTML = html;

            // Log
            const recentLog = [...log].reverse().slice(0, 10);
            let logHtml = "";
            recentLog.forEach(l => {
                logHtml += `<li>${l.buyer} hat <b>${l.item}</b> am ${l.date} gekauft.</li>`;
            });
            document.getElementById('shop-log-list').innerHTML = logHtml || "<li>Noch nichts gekauft</li>";
        }

        window.addShopItem = async () => {
            const input = document.getElementById('shop-input');
            const name = input.value.trim();
            if(!name) return;

            const docRef = doc(db, "wg_app", "state_v3");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const currentList = data.shopping && data.shopping.list ? data.shopping.list : [];
            const newList = [...currentList, { name: name }];
            
            await updateDoc(docRef, { "shopping.list": newList });
            input.value = ""; 
        };

        window.buyItem = async (index, itemName) => {
            if(!confirm(`Hast du (Alex) "${itemName}" gekauft?\n\n(OK = Alex, Abbrechen = Fred)`)) {
                if(!confirm(`War es Fred?`)) return; 
                var buyer = "Fred";
            } else {
                var buyer = "Alex";
            }

            const docRef = doc(db, "wg_app", "state_v3");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const newList = [...data.shopping.list];
            newList.splice(index, 1);

            const now = new Date();
            const dateStr = now.toLocaleDateString('de-DE');
            const logEntry = { buyer: buyer, item: itemName, date: dateStr };
            const newLog = data.shopping.log ? [...data.shopping.log, logEntry] : [logEntry];

            await updateDoc(docRef, { "shopping.list": newList, "shopping.log": newLog });
        };

        // --- MAIN APP LOAD ---
        function loadApp() {
            onSnapshot(doc(db, "wg_app", "state_v3"), (docSnap) => {
                if (!docSnap.exists()) {
                    // Fallback Init f√ºr komplett leere DB
                    initDatabase(); 
                    return;
                }
                const data = docSnap.data();
                
                renderDashboardWidget(data);
                
                // Putz
                document.getElementById('score-me').innerText = data.users.me.score;
                document.getElementById('score-him').innerText = data.users.him.score;
                let html = "";
                html += renderUserCard("me", "Alex", data.users.me);
                html += renderUserCard("him", "Fred", data.users.him);
                document.getElementById('task-container').innerHTML = html;

                // Stats
                const history = data.history || [];
                document.getElementById('stats-alex').innerHTML = calculateStats(history, "me");
                document.getElementById('stats-fred').innerHTML = calculateStats(history, "him");
                const recentHistory = [...history].reverse().slice(0, 5);
                let historyHtml = "";
                recentHistory.forEach(h => {
                    const name = h.user === "me" ? "Alex" : "Fred";
                    historyHtml += `<li><b>${name}</b>: ${h.task} (${h.points} Pkt / ${h.daysTaken}T)</li>`;
                });
                document.getElementById('history-list').innerHTML = historyHtml || "<li>Leer</li>";

                // Finanzen
                if(data.finance) renderFinance(data);
                
                // Einkaufen
                if(data.shopping) renderShopping(data);
            });
        }

        // --- DB ACTIONS ---
        window.completeTask = async (userId, pointsToAdd, currentTaskName, daysTaken) => {
            if(!confirm(`Aufgabe erledigt?`)) return;
            const docRef = doc(db, "wg_app", "state_v3");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();
            const currentUserData = data.users[userId];
            const nextTask = (currentTaskName === "Bad putzen") ? "K√ºche putzen" : "Bad putzen";
            const newScore = currentUserData.score + pointsToAdd;
            const newUserData = { score: newScore, currentTask: nextTask, lastCleaned: Timestamp.now() };
            const historyEntry = { user: userId, task: currentTaskName, points: pointsToAdd, daysTaken: daysTaken, date: Timestamp.now() };
            const newHistory = data.history ? [...data.history, historyEntry] : [historyEntry];
            await updateDoc(docRef, { [`users.${userId}`]: newUserData, history: newHistory });
        };

        // --- MODULARE RESET FUNKTIONEN ---

        // 1. NUR PUTZEN
        window.resetCleaning = async () => {
            if(!confirm("Nur Putzdaten & Statistiken l√∂schen?")) return;
            const docRef = doc(db, "wg_app", "state_v3");
            await updateDoc(docRef, {
                users: {
                    me: { score: 0, currentTask: "Bad putzen", lastCleaned: Timestamp.now() },
                    him: { score: 0, currentTask: "K√ºche putzen", lastCleaned: Timestamp.now() }
                },
                history: []
            });
        }

        // 2. NUR FINANZEN
        window.resetFinance = async () => {
            if(!confirm("Nur Finanzen zur√ºcksetzen?")) return;
            const docRef = doc(db, "wg_app", "state_v3");
            await updateDoc(docRef, {
                finance: {
                    costs: {
                        rent: { val: 850.00, day: 1 },
                        gas: { val: 120.00, day: 1 },
                        strom: { val: 85.00, day: 1 },
                        gez: { val: 55.08, day: 13 },
                        internet: { val: 39.99, day: 1 }
                    },
                    history: []
                }
            });
        }

        // 3. NUR SHOPPING
        window.resetShopping = async () => {
            if(!confirm("Einkaufsliste leeren?")) return;
            const docRef = doc(db, "wg_app", "state_v3");
            
            // Falls das Modul noch gar nicht existiert (Update w√ºrde failen), m√ºssen wir set mit merge nutzen oder update
            // Da updateDoc failt wenn Feld nicht da ist, nutzen wir setDoc mit merge f√ºr "init" Charakter
            // Aber hier wollen wir nur das Feld √ºberschreiben.
            // Safe way:
            await setDoc(docRef, {
                shopping: {
                    list: [],
                    log: []
                }
            }, { merge: true });
        }

        // Init (nur falls DB komplett gel√∂scht wurde)
        async function initDatabase() {
            await setDoc(doc(db, "wg_app", "state_v3"), {
                users: { me: { score: 0, currentTask: "...", lastCleaned: Timestamp.now() }, him: { score: 0, currentTask: "...", lastCleaned: Timestamp.now() } },
                history: [],
                finance: { costs: {}, history: [] },
                shopping: { list: [], log: [] }
            });
        }
        
        loadApp();
    </script>
</body>
</html>
