<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Zentrale</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* --- GLOBAL DESIGN --- */
        body { padding: 10px; background-color: #f0f2f5; color: #1d1d1d; min-height: 100vh; }
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; color: #333; }
        
        /* Views Management */
        .app-view { display: none; }
        .app-view.active { display: block; }

        /* --- DASHBOARD (STARTSEITE) STYLES --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        .module-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
            cursor: pointer; transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .module-card:active { transform: scale(0.98); }
        
        .module-icon { font-size: 2em; margin-bottom: 10px; display: block; }
        .module-title { font-weight: bold; font-size: 1.2em; margin-bottom: 5px; }
        
        /* Live Widget im Dashboard */
        .widget-content { font-size: 0.9em; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }
        .widget-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }

        /* Placeholder Modules */
        .module-card.disabled { opacity: 0.6; cursor: default; filter: grayscale(1); }
        .module-card.disabled:active { transform: none; }

        /* --- PUTZ-APP SPECIFIC STYLES --- */
        .back-header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; font-size: 1.5rem; padding: 0 10px 0 0; color: #333; width: auto; }
        
        .card { background-color: #ffffff; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        .score-display { font-size: 2.5em; font-weight: bold; text-align: center; color: #2d3436; }
        .score-label { text-transform: uppercase; letter-spacing: 1px; font-size: 0.8em; color: #636e72; font-weight: bold; }
        .task-title { font-size: 1.3em; font-weight: bold; margin-bottom: 5px; color: #000; }
        .deadline { font-size: 0.9em; font-weight: bold; margin-bottom: 10px; }
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 12px; margin-top: 10px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9em; }
        .stat-val { font-weight: bold; }

        /* Navigation unten (nur in Putz App sichtbar) */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { text-align: center; font-size: 0.9em; color: #888; cursor: pointer; flex: 1; }
        .nav-item.active { color: #0984e3; font-weight: bold; }

        /* Farben */
        .color-good { color: #00b894; } .bg-good { background-color: #00b894; }
        .color-warn { color: #e17055; } .bg-warn { background-color: #e17055; }
        .color-bad { color: #d63031; } .bg-bad { background-color: #d63031; }

        /* Sub-View Umschalter in Putz App */
        .sub-view { display: none; }
        .sub-view.active { display: block; padding-bottom: 80px; }
        
        button.action-btn { background-color: #0984e3; border: none; width: auto; padding: 8px 20px; font-size: 0.9em; margin-bottom: 0; }
        button.danger { background-color: #d63031; border: none; opacity: 0.8; font-size: 0.8rem; margin-top: 10px;}
    </style>
</head>
<body>

    <main class="container">
        
        <div id="view-main-menu" class="app-view active">
            <h1>üè† WG Zentrale</h1>
            
            <div class="dashboard-grid">
                
                <div class="module-card" onclick="openModule('cleaning')">
                    <span class="module-icon">üßπ</span>
                    <div class="module-title">Putzplan</div>
                    
                    <div class="widget-content" id="dashboard-summary">
                        Lade Status...
                    </div>
                </div>

                <div class="module-card disabled">
                    <span class="module-icon">üõí</span>
                    <div class="module-title">Einkaufsliste</div>
                    <small>Kommt bald</small>
                </div>

                <div class="module-card disabled">
                    <span class="module-icon">üí∏</span>
                    <div class="module-title">Finanzen</div>
                    <small>Kommt bald</small>
                </div>

            </div>
        </div>


        <div id="view-cleaning" class="app-view">
            
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Putz-Planer</h2>
            </div>

            <div id="sub-dashboard" class="sub-view active">
                <article class="card">
                    <header>üèÜ Highscore</header>
                    <div class="grid">
                        <div style="text-align: center;">
                            <div class="score-label">Alex</div>
                            <div id="score-me" class="score-display">-</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="score-label">Fred</div>
                            <div id="score-him" class="score-display">-</div>
                        </div>
                    </div>
                </article>

                <div id="task-container">Lade Daten...</div>
            </div>

            <div id="sub-stats" class="sub-view">
                <article class="card">
                    <header>üìä Analyse: Alex</header>
                    <div id="stats-alex">Lade...</div>
                </article>
                <article class="card">
                    <header>üìä Analyse: Fred</header>
                    <div id="stats-fred">Lade...</div>
                </article>
                <article class="card">
                    <header>üìú Verlauf</header>
                    <ul id="history-list" style="font-size: 0.8em; padding-left: 20px;"></ul>
                </article>
                
                <details style="margin-top: 30px;">
                    <summary style="color:#666; font-size:0.9em;">Admin</summary>
                    <button class="danger" onclick="resetDatabase()">‚ö†Ô∏è Datenbank Reset</button>
                </details>
            </div>

            <div class="bottom-nav">
                <div class="nav-item active" onclick="switchSubTab('dashboard', this)">
                    <span style="display:block; font-size:1.5em;">üßπ</span> Plan
                </div>
                <div class="nav-item" onclick="switchSubTab('stats', this)">
                    <span style="display:block; font-size:1.5em;">üìà</span> Stats
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVIGATION ---
        window.openModule = (moduleId) => {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + moduleId).classList.add('active');
        };

        window.switchSubTab = (subId, element) => {
            document.querySelectorAll('.sub-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('sub-' + subId).classList.add('active');
            element.classList.add('active');
        };

        // --- LOGIK ---
        function calculatePoints(daysPassed) {
            if (daysPassed < 4) return 15;
            if (daysPassed < 6) return 10;
            if (daysPassed < 7) return 5;
            if (daysPassed < 8) return 2;
            return -5;
        }

        function getStatusInfo(lastCleanedDate) {
            const now = new Date();
            const daysPassed = Math.floor((now - lastCleanedDate.toDate()) / (1000 * 60 * 60 * 24));
            
            let color = "#00b894"; // Gr√ºn
            if(daysPassed >= 4) color = "#e17055"; // Orange
            if(daysPassed >= 7) color = "#d63031"; // Rot
            
            return { days: daysPassed, color: color };
        }

        // --- RENDERERS ---
        function renderDashboardWidget(data) {
            const alexStatus = getStatusInfo(data.users.me.lastCleaned);
            const fredStatus = getStatusInfo(data.users.him.lastCleaned);

            return `
                <div class="widget-row">
                    <span>Alex: ${data.users.me.currentTask}</span>
                    <span><span class="status-dot" style="background:${alexStatus.color}"></span> ${alexStatus.days}T</span>
                </div>
                <div class="widget-row">
                    <span>Fred: ${data.users.him.currentTask}</span>
                    <span><span class="status-dot" style="background:${fredStatus.color}"></span> ${fredStatus.days}T</span>
                </div>
            `;
        }

        function renderUserCard(userId, userName, userData) {
            const status = getStatusInfo(userData.lastCleaned);
            const pointsNow = calculatePoints(status.days);
            
            let statusText = "Alles gut";
            let borderColor = status.color;

            if(status.days >= 4) statusText = "Zeit l√§uft ab...";
            if(status.days >= 7) statusText = "√úBERF√ÑLLIG!";

            let progress = (status.days / 7) * 100;
            if(progress > 100) progress = 100;

            let html = `<article class="card" style="border-left: 6px solid ${borderColor}">`;
            html += `<header style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">`;
            html += `<span style="font-size:1.1em; color:#333;">üë§ <b>${userName}</b></span>`;
            html += `<span style="font-size:0.8em; color:#888;">Seit ${status.days} Tagen</span>`;
            html += `</header>`;
            html += `<div class="task-title">${userData.currentTask}</div>`;
            html += `<div class="deadline" style="color:${borderColor}">${statusText}</div>`;
            html += `<div class="progress-container"><div class="progress-bar" style="width: ${progress}%; background-color:${borderColor}"></div></div>`;
            html += `<div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span style="color:#555;">Punkte: <b style="color:${borderColor}">${pointsNow}</b></span>`;
            html += `<button class="action-btn" onclick="window.completeTask('${userId}', ${pointsNow}, '${userData.currentTask}', ${status.days})">Erledigt ‚úÖ</button>`;
            html += `</div>`;
            html += `</article>`;
            return html;
        }

        function calculateStats(history, userId) {
            const userHistory = history.filter(h => h.user === userId);
            if (userHistory.length === 0) return `<div style="text-align:center; color:#999;">Noch keine Daten</div>`;

            const totalCleans = userHistory.length;
            const totalDays = userHistory.reduce((sum, entry) => sum + entry.daysTaken, 0);
            const avgDays = (totalDays / totalCleans).toFixed(1);
            const lates = userHistory.filter(h => h.daysTaken >= 7).length;
            const fastest = Math.min(...userHistory.map(h => h.daysTaken));

            return `
                <div class="stat-row"><span>üßπ Anzahl:</span> <span class="stat-val">${totalCleans}</span></div>
                <div class="stat-row"><span>‚è±Ô∏è √ò Dauer:</span> <span class="stat-val">${avgDays} Tage</span></div>
                <div class="stat-row"><span>üê¢ Versp√§tet:</span> <span class="stat-val" style="color:${lates > 0 ? '#d63031' : 'inherit'}">${lates}x</span></div>
                <div class="stat-row"><span>üèéÔ∏è Rekord:</span> <span class="stat-val">${fastest} Tage</span></div>
            `;
        }

        // --- MAIN APP LOAD ---
        function loadApp() {
            onSnapshot(doc(db, "wg_app", "state_v3"), (docSnap) => {
                if (!docSnap.exists()) {
                    initDatabase(); // Auto-Init wenn noch nichts da ist
                    return;
                }

                const data = docSnap.data();
                
                // 1. DASHBOARD WIDGET UPDATEN
                document.getElementById('dashboard-summary').innerHTML = renderDashboardWidget(data);

                // 2. PUTZ APP RENDERN
                document.getElementById('score-me').innerText = data.users.me.score;
                document.getElementById('score-him').innerText = data.users.him.score;

                let html = "";
                html += renderUserCard("me", "Alex", data.users.me);
                html += renderUserCard("him", "Fred", data.users.him);
                document.getElementById('task-container').innerHTML = html;

                // 3. STATS RENDERN
                const history = data.history || [];
                document.getElementById('stats-alex').innerHTML = calculateStats(history, "me");
                document.getElementById('stats-fred').innerHTML = calculateStats(history, "him");
                
                const recentHistory = [...history].reverse().slice(0, 5);
                let historyHtml = "";
                recentHistory.forEach(h => {
                    const name = h.user === "me" ? "Alex" : "Fred";
                    historyHtml += `<li><b>${name}</b>: ${h.task} (${h.points} Pkt / ${h.daysTaken}T)</li>`;
                });
                document.getElementById('history-list').innerHTML = historyHtml || "<li>Leer</li>";
            });
        }

        // --- AKTIONEN ---
        window.completeTask = async (userId, pointsToAdd, currentTaskName, daysTaken) => {
            if(!confirm(`Aufgabe erledigt?`)) return;

            const docRef = doc(db, "wg_app", "state_v3");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const currentUserData = data.users[userId];
            const nextTask = (currentTaskName === "Bad putzen") ? "K√ºche putzen" : "Bad putzen";
            const newScore = currentUserData.score + pointsToAdd;

            const newUserData = {
                score: newScore,
                currentTask: nextTask,
                lastCleaned: Timestamp.now() 
            };

            const historyEntry = { user: userId, task: currentTaskName, points: pointsToAdd, daysTaken: daysTaken, date: Timestamp.now() };
            const newHistory = data.history ? [...data.history, historyEntry] : [historyEntry];

            await updateDoc(docRef, { [`users.${userId}`]: newUserData, history: newHistory });
        };

        async function initDatabase() {
            await setDoc(doc(db, "wg_app", "state_v3"), {
                users: {
                    me: { score: 0, currentTask: "Bad putzen", lastCleaned: Timestamp.now() },
                    him: { score: 0, currentTask: "K√ºche putzen", lastCleaned: Timestamp.now() }
                },
                history: []
            });
        }
        window.resetDatabase = async () => { if(confirm("Reset?")) { await initDatabase(); location.reload(); } }

        loadApp();
    </script>
</body>
</html>
