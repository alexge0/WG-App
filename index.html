<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Zentrale</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* --- GLOBAL --- */
        body { padding: 10px; background-color: #f0f2f5; color: #1d1d1d; min-height: 100vh; padding-bottom: 80px;}
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; color: #333; }
        
        .app-view { display: none; }
        .app-view.active { display: block; }

        /* --- DASHBOARD --- */
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        .module-card {
            background: white; border-radius: 15px; padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
            cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .module-card:active { transform: scale(0.98); }
        
        .module-icon { font-size: 2.5em; margin-bottom: 10px; display: block; }
        .module-title { font-weight: bold; font-size: 1.3em; margin-bottom: 5px; }
        .widget-content { font-size: 0.9em; color: #666; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f0f0f0; }

        /* --- CARDS --- */
        .card { background-color: #ffffff; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }

        /* --- HEADER --- */
        .back-header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: none; border: none; font-size: 1.5rem; padding: 0 10px 0 0; color: #333; width: auto; }

        /* --- SCORE --- */
        .score-display { font-size: 3em; font-weight: bold; text-align: center; color: #2d3436; cursor: pointer; position: relative; display: inline-block; line-height: 1; }
        .score-display:after { content: '‚úèÔ∏è'; font-size: 0.2em; position: absolute; top: 0; right: -15px; opacity: 0.3; }
        .score-label { text-transform: uppercase; letter-spacing: 1px; font-size: 0.8em; color: #636e72; font-weight: bold; }

        /* --- ROOM CARDS --- */
        .room-header { display: flex; justify-content: space-between; align-items: center; }
        
        /* Editierbare Badges */
        .assignee-badge { background: #0984e3; color: white; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9em; cursor: pointer; border: 1px solid transparent; }
        .assignee-badge:hover { border-color: white; opacity: 0.9; }
        .assignee-badge:after { content: '‚úèÔ∏è'; font-size: 0.8em; margin-left: 5px; opacity: 0.6; }

        .deadline { font-weight: bold; margin-top: 15px; font-size: 0.9em; cursor: pointer; display: inline-block; }
        .deadline:hover { text-decoration: underline; }
        .deadline:after { content: ' ‚úèÔ∏è'; font-size: 0.8em; opacity: 0.5; }

        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; height: 10px; margin-top: 5px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }

        /* COLORS */
        .color-good { color: #00b894; } .bg-good { background-color: #00b894; }
        .color-warn { color: #e17055; } .bg-warn { background-color: #e17055; }
        .color-bad { color: #d63031; } .bg-bad { background-color: #d63031; }

        /* BUTTONS */
        button.action-btn { background-color: #0984e3; border: none; width: 100%; margin-top: 20px; padding: 12px; font-weight: bold; }
        button.danger { background-color: #d63031; border: none; opacity: 0.8; font-size: 0.8rem; margin-top: 10px;}
        button.add-btn { background-color: #00b894; border: none; width: auto; margin-bottom: 0; }

        /* LISTS */
        .shop-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .shop-input-group input { margin-bottom: 0; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .check-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; color:#00b894; font-weight:bold;}
        .edit-link { font-size: 0.8em; color: #0984e3; text-decoration: none; cursor: pointer; margin-left: 10px; }
        
        /* LOGBUCH */
        #cleaning-log ul { list-style: none; padding: 0; }
        #cleaning-log li { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.85em; color: #555; }
        #cleaning-log li b { color: #333; }
    </style>
</head>
<body>

    <main class="container">
        
        <div id="view-main-menu" class="app-view active">
            <h1>üè† WG Zentrale</h1>
            
            <div class="dashboard-grid">
                
                <div class="module-card" onclick="openModule('cleaning')">
                    <span class="module-icon">üßπ</span>
                    <div class="module-title">Putzplan</div>
                    <div class="widget-content" id="dashboard-summary">Lade...</div>
                </div>

                <div class="module-card" onclick="openModule('shopping')">
                    <span class="module-icon">üõí</span>
                    <div class="module-title">Einkaufsliste</div>
                    <div class="widget-content" id="shop-widget-summary">Lade...</div>
                </div>

                <div class="module-card" onclick="openModule('finance')">
                    <span class="module-icon">üí∏</span>
                    <div class="module-title">Finanzen</div>
                    <div class="widget-content" id="fin-widget-summary">Lade...</div>
                </div>

                <div class="module-card" onclick="openModule('stats')">
                    <span class="module-icon">‚öôÔ∏è</span>
                    <div class="module-title">Admin</div>
                    <div class="widget-content">Verlauf & Reset</div>
                </div>

            </div>
        </div>

        <div id="view-cleaning" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Putz-Planer</h2>
            </div>

            <article class="card">
                <header>üèÜ Highscore</header>
                <div class="grid">
                    <div style="text-align: center;">
                        <div class="score-label">Alex</div>
                        <div id="score-alex" class="score-display" onclick="editScore('Alex')">-</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="score-label">Fred</div>
                        <div id="score-fred" class="score-display" onclick="editScore('Fred')">-</div>
                    </div>
                </div>
            </article>

            <div id="rooms-container">
                <p aria-busy="true">Lade Plan...</p>
            </div>
        </div>

        <div id="view-shopping" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Einkaufsliste</h2>
            </div>

            <article class="card">
                <div class="shop-input-group">
                    <input type="text" id="shop-input" placeholder="Was fehlt?" style="margin-bottom:0;">
                    <button class="add-btn" onclick="window.addShopItem()">+</button>
                </div>
                <div id="shopping-list"></div>
            </article>

            <article class="card">
                <header>Verlauf</header>
                <ul id="shopping-log" style="font-size:0.8em; color:#666; padding-left:20px; margin-bottom:0;"></ul>
            </article>
        </div>

        <div id="view-finance" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Finanzen</h2>
            </div>

            <article class="card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border:none;">
                <header style="border-bottom: 1px solid rgba(255,255,255,0.2);">Monatliche Belastung</header>
                <div style="font-size: 2.5em; font-weight: bold; text-align: center;">
                    <span id="fin-total">0</span> ‚Ç¨
                </div>
                <div class="grid" style="margin-top:15px; text-align:center; font-size:0.9em;">
                    <div><small style="opacity:0.8">Alex (55%)</small><br><b id="fin-share-me">0 ‚Ç¨</b></div>
                    <div><small style="opacity:0.8">Fred (45%)</small><br><b id="fin-share-him">0 ‚Ç¨</b></div>
                </div>
            </article>

            <article class="card">
                <header>Fixkosten</header>
                <div id="cost-list">Lade...</div>
                <small style="display:block; text-align:center; color:#888; margin-top:10px;">* GEZ wird anteilig berechnet</small>
            </article>
        </div>

        <div id="view-stats" class="app-view">
            <div class="back-header">
                <button class="back-btn" onclick="openModule('main-menu')">‚ùÆ</button>
                <h2 style="margin:0; font-size: 1.2rem;">Admin & Verlauf</h2>
            </div>

            <article class="card">
                <header>Logbuch (Alle √Ñnderungen)</header>
                <div id="cleaning-log" style="font-size:0.8em;"></div>
            </article>

            <div id="setup-container" style="text-align:center; margin-top:20px;">
                <button class="danger" onclick="startFresh()">‚ö†Ô∏è ALLES NEUSTARTEN</button>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- HIER DEINE TELEGRAM DATEN EINF√úGEN ---
        const TG_TOKEN = "8571178906:AAF3FhPeVo3_LGH1WAKQEiH76dml3Lya4pY"; 
        const TG_CHAT_ID = "-4996341100"; 

        async function sendTelegramMessage(text) {
            if(!TG_TOKEN || !TG_CHAT_ID) return;
            const url = `https://api.telegram.org/bot${TG_TOKEN}/sendMessage`;
            try {
                await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TG_CHAT_ID, text: text, parse_mode: 'Markdown' }) });
            } catch (e) { console.error("Telegram Fehler:", e); }
        }

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVIGATION ---
        window.openModule = (moduleId) => {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + moduleId).classList.add('active');
        };

        // --- LOGIK: PUNKTE ---
        function calculatePoints(daysPassed) {
            if (daysPassed < 4) return 15;
            if (daysPassed < 6) return 10;
            if (daysPassed < 7) return 5;
            if (daysPassed < 8) return 2;
            const overdue = daysPassed - 8;
            return -5 - (overdue * 5);
        }

        // --- HELPER: LOGBUCH SCHREIBEN ---
        async function logAction(docRef, data, text) {
            const historyEntry = { 
                txt: text, 
                date: new Date().toLocaleDateString('de-DE') + " " + new Date().toLocaleTimeString('de-DE').slice(0,5)
            };
            const newHistory = [historyEntry, ...(data.history || [])];
            await updateDoc(docRef, { history: newHistory });
        }

        // --- RENDER ROOM CARD (MIT EDITIER-FUNKTIONEN) ---
        function renderRoomCard(roomKey, roomData) {
            const assignee = roomData.assignee;
            const now = new Date();
            const lastCleanedDate = roomData.lastCleaned.toDate();
            const daysPassed = Math.floor((now - lastCleanedDate) / (1000 * 60 * 60 * 24));
            const points = calculatePoints(daysPassed);

            let colorClass = "color-good";
            let bgClass = "bg-good";
            let statusText = "Alles gut";
            
            if(daysPassed >= 4) { colorClass = "color-warn"; bgClass = "bg-warn"; statusText = "Zeit l√§uft ab..."; }
            if(daysPassed >= 7) { colorClass = "color-bad"; bgClass = "bg-bad"; statusText = "√úBERF√ÑLLIG!"; }

            let progress = (daysPassed / 7) * 100;
            if(progress > 100) progress = 100;

            const icon = roomKey === "Bad" ? "üõÅ" : "üç≥";
            const roomName = roomKey === "Bad" ? "Das Bad" : "Die K√ºche";

            return `
            <article class="card" style="border-left: 5px solid var(--${colorClass.replace('color-', '')})">
                <div class="room-header">
                    <div>
                        <span style="font-size:1.5em; margin-right:10px;">${icon}</span>
                        <span style="font-weight:bold; font-size:1.2em;">${roomName}</span>
                    </div>
                    <span class="assignee-badge" onclick="editAssignee('${roomKey}', '${assignee}')">üë§ ${assignee}</span>
                </div>
                <div class="deadline ${colorClass}" onclick="editLastCleaned('${roomKey}')">
                    ${statusText} (Tag ${daysPassed})
                </div>
                <div class="progress-container">
                    <div class="progress-bar ${bgClass}" style="width: ${progress}%"></div>
                </div>
                <button class="action-btn" onclick="finishTask('${roomKey}', '${assignee}', ${points})">
                    ‚úÖ Erledigt (+${points} Pkt)
                </button>
            </article>
            `;
        }

        function renderFinance(finance) {
            let monthlyTotal = 0;
            let html = "<table style='width:100%'>";
            
            Object.keys(finance.costs || {}).forEach(k => {
                const item = finance.costs[k];
                const isGEZ = k === 'GEZ'; 
                let monthVal = item.val;
                if(isGEZ || item.val === 55.08) monthVal = item.val / 3; 
                monthlyTotal += monthVal;

                let valText = `${item.val} ‚Ç¨`;
                if(isGEZ || item.val === 55.08) valText += " / Q";

                html += `
                <tr>
                    <td style="padding:10px 0;">
                        <b>${k}</b><br>
                        <small style="color:#888;">Tag ${item.day || 1}</small>
                    </td>
                    <td style="text-align:right;">
                        <b>${valText}</b><br>
                        <a class="edit-link" onclick="editCost('${k}', ${item.val})">Bearbeiten</a>
                    </td>
                </tr>`;
            });
            html += "</table>";
            
            document.getElementById('cost-list').innerHTML = html;
            document.getElementById('fin-total').innerText = monthlyTotal.toFixed(2);
            document.getElementById('fin-share-me').innerText = (monthlyTotal * 0.55).toFixed(2) + " ‚Ç¨";
            document.getElementById('fin-share-him').innerText = (monthlyTotal * 0.45).toFixed(2) + " ‚Ç¨";
            document.getElementById('fin-widget-summary').innerText = `Gesamt: ${monthlyTotal.toFixed(0)}‚Ç¨ / Monat`;
        }

        // --- HAUPTFUNKTION ---
        function loadApp() {
            onSnapshot(doc(db, "wg_app", "wg_app_v5_independent"), (docSnap) => {
                if (!docSnap.exists()) return; 
                const data = docSnap.data();

                // 1. Dashboard Widget Putzen
                const alexRoom = data.rooms.Kueche.assignee === "Alex" ? "K√ºche" : "Bad";
                const fredRoom = data.rooms.Kueche.assignee === "Fred" ? "K√ºche" : "Bad";
                document.getElementById('dashboard-summary').innerHTML = `
                    <div class="widget-row"><span>Alex: ${alexRoom}</span><span>${data.scores.Alex} Pkt</span></div>
                    <div class="widget-row"><span>Fred: ${fredRoom}</span><span>${data.scores.Fred} Pkt</span></div>
                `;

                // 2. Putz Ansicht
                document.getElementById('score-alex').innerText = data.scores.Alex;
                document.getElementById('score-fred').innerText = data.scores.Fred;
                
                let roomHtml = "";
                if(data.rooms.Kueche) roomHtml += renderRoomCard("Kueche", data.rooms.Kueche);
                if(data.rooms.Bad) roomHtml += renderRoomCard("Bad", data.rooms.Bad);
                document.getElementById('rooms-container').innerHTML = roomHtml;

                // 3. Module
                if(data.finance) renderFinance(data.finance);
                
                // 4. Shopping
                const list = data.shopping.list || [];
                let sHtml = "";
                list.forEach((item, i) => sHtml += `<div class="list-item"><span>${item}</span><div class="check-btn" onclick="buyItem(${i}, '${item}')">‚úî</div></div>`);
                if(list.length === 0) sHtml = "<p style='text-align:center;color:#999'>Alles da!</p>";
                document.getElementById('shopping-list').innerHTML = sHtml;
                document.getElementById('shop-widget-summary').innerText = list.length > 0 ? `${list.length} Teile fehlen` : "Alles da ‚úÖ";
                
                let sLogHtml = "";
                (data.shopping.log || []).slice(0,5).forEach(l => sLogHtml += `<li>${l}</li>`);
                document.getElementById('shopping-log').innerHTML = sLogHtml;

                // 5. Logbuch (Cleaning + Finance)
                if(data.history) {
                    let hHtml = "<ul>";
                    data.history.slice(0,15).forEach(h => hHtml += `<li><b>${h.date}</b>: ${h.txt}</li>`);
                    hHtml += "</ul>";
                    document.getElementById('cleaning-log').innerHTML = hHtml;
                }
            });
        }

        // --- EDIT FUNCTIONS (MIT LOGGING) ---
        
        // 1. Punkte √§ndern
        window.editScore = async (user) => {
            const current = document.getElementById(user === 'Alex' ? 'score-alex' : 'score-fred').innerText;
            const newVal = prompt(`Punkte f√ºr ${user} bearbeiten:`, current);
            if(newVal === null) return;
            const intVal = parseInt(newVal);
            if(isNaN(intVal)) return alert("Zahl eingeben!");
            
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { [`scores.${user}`]: intVal });
            await logAction(docRef, snap.data(), `‚úèÔ∏è Punkte ${user} ge√§ndert: ${current} -> ${intVal}`);
        };

        // 2. Kosten √§ndern
        window.editCost = async (key, currentVal) => {
            const newVal = prompt(`Neuer Betrag f√ºr ${key}:`, currentVal);
            if(newVal === null) return;
            const floatVal = parseFloat(newVal.replace(',', '.'));
            if(isNaN(floatVal)) return alert("Zahl eingeben!");
            
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { [`finance.costs.${key}.val`]: floatVal });
            await logAction(docRef, snap.data(), `üí∞ ${key} Kosten ge√§ndert: ${currentVal}‚Ç¨ -> ${floatVal}‚Ç¨`);
        };

        // 3. Zust√§ndigen √§ndern (NEU)
        window.editAssignee = async (roomKey, currentAssignee) => {
            const newAssignee = currentAssignee === "Alex" ? "Fred" : "Alex";
            if(!confirm(`Zust√§ndigen f√ºr ${roomKey} √§ndern auf ${newAssignee}?`)) return;
            
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { [`rooms.${roomKey}.assignee`]: newAssignee });
            await logAction(docRef, snap.data(), `‚úèÔ∏è Zust√§ndigkeit ${roomKey}: ${currentAssignee} -> ${newAssignee}`);
        };

        // 4. Datum √§ndern (NEU)
        window.editLastCleaned = async (roomKey) => {
            const daysAgo = prompt(`Vor wie vielen Tagen wurde ${roomKey} zuletzt geputzt? (0 = Heute)`);
            if(daysAgo === null) return;
            const days = parseInt(daysAgo);
            if(isNaN(days)) return alert("Zahl eingeben!");

            const newDate = new Date();
            newDate.setDate(newDate.getDate() - days);

            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            await updateDoc(docRef, { [`rooms.${roomKey}.lastCleaned`]: Timestamp.fromDate(newDate) });
            await logAction(docRef, snap.data(), `‚úèÔ∏è Datum ${roomKey} korrigiert auf vor ${days} Tagen`);
        };

        // --- TASK ACTIONS ---
        window.finishTask = async (roomKey, currentAssignee, points) => {
            const roomName = roomKey === "Kueche" ? "K√ºche" : "Bad";
            if(!confirm(`${currentAssignee} hat ${roomName} geputzt?`)) return;

            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            const data = snap.data();

            const nextAssignee = (currentAssignee === "Alex") ? "Fred" : "Alex";
            const newScore = data.scores[currentAssignee] + points;

            const updates = {};
            updates[`scores.${currentAssignee}`] = newScore;
            updates[`rooms.${roomKey}.assignee`] = nextAssignee;
            updates[`rooms.${roomKey}.lastCleaned`] = Timestamp.now();
            
            // Log entry manuell bauen, da finishTask komplexer ist
            const logTxt = `‚úÖ ${currentAssignee} hat ${roomName} geputzt (+${points})`;
            const historyEntry = { txt: logTxt, date: new Date().toLocaleDateString('de-DE') + " " + new Date().toLocaleTimeString('de-DE').slice(0,5) };
            updates['history'] = [historyEntry, ...(data.history || [])];

            await updateDoc(docRef, updates);

            // Telegram Trigger
            sendTelegramMessage(`‚úÖ *${currentAssignee} hat geputzt!*\n\nRaum: ${roomName}\nPunkte: +${points}\n\nNeu zust√§ndig: ${nextAssignee}`);
        };

        // --- SHOPPING ACTIONS ---
        window.addShopItem = async () => {
            const val = document.getElementById('shop-input').value;
            if(!val) return;
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            const list = snap.data().shopping.list || [];
            await updateDoc(docRef, { "shopping.list": [...list, val] });
            document.getElementById('shop-input').value = "";
        };

        window.buyItem = async (idx, name) => {
            if(!confirm(`${name} gekauft?`)) return;
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            const data = snap.data();
            const list = [...data.shopping.list];
            list.splice(idx, 1);
            const logEntry = `‚úÖ ${name} gekauft`;
            const newLog = [logEntry, ...(data.shopping.log || [])];
            await updateDoc(docRef, { "shopping.list": list, "shopping.log": newLog });
        };

        // --- RESET / INIT ---
        window.startFresh = async () => {
            if(!confirm("Alles l√∂schen und neu starten?\n\nAlex -> Bad\nFred -> K√ºche")) return;
            const now = Timestamp.now();
            await setDoc(doc(db, "wg_app", "wg_app_v5_independent"), {
                scores: { Alex: 0, Fred: 0 },
                rooms: {
                    Bad: { assignee: "Alex", lastCleaned: now },
                    Kueche: { assignee: "Fred", lastCleaned: now }
                },
                shopping: { list: [], log: [] },
                history: [{txt: "üöÄ System neu gestartet", date: new Date().toLocaleDateString()}],
                finance: { 
                    costs: {
                        Miete: { val: 850, day: 1 }, 
                        Strom: { val: 85, day: 1 }, 
                        Gas: { val: 100, day: 1 }, // Neu: GAS
                        Internet: { val: 40, day: 1 },
                        GEZ: { val: 55.08, day: 15 }
                    }
                }
            });
            location.reload();
        };

        loadApp();
    </script>
</body>
</html>
