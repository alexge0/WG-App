<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Zentrale</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* --- GLOBAL DESIGN --- */
        body { padding: 10px; background-color: #f0f2f5; color: #1d1d1d; min-height: 100vh; padding-bottom: 80px;}
        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 20px; color: #333; }
        
        .app-view { display: none; }
        .app-view.active { display: block; }
        .card { background-color: #ffffff; border-radius: 15px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #e0e0e0; }
        
        /* HIGHSCORE BAR (Dezent) */
        .highscore-bar { display: flex; justify-content: space-between; background: white; padding: 10px 20px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .score-item { font-weight: bold; color: #555; }
        .score-val { color: #0984e3; margin-left: 5px; }

        /* ROOM CARD STYLES */
        .room-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .room-title { display: flex; align-items: center; font-size: 1.2em; font-weight: bold; }
        .room-icon { font-size: 1.5em; margin-right: 10px; }
        
        /* Der Chip, der anzeigt wer dran ist */
        .assignee-badge { background: #dfe6e9; color: #2d3436; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.85em; border: 1px solid #b2bec3; }
        
        .deadline { font-weight: bold; margin-top: 15px; font-size: 0.9em; }
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; height: 8px; margin-top: 5px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }

        /* COLORS */
        .color-good { color: #00b894; } .bg-good { background-color: #00b894; }
        .color-warn { color: #e17055; } .bg-warn { background-color: #e17055; }
        .color-bad { color: #d63031; } .bg-bad { background-color: #d63031; }

        /* NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { text-align: center; font-size: 0.9em; color: #888; cursor: pointer; flex: 1; }
        .nav-item.active { color: #0984e3; font-weight: bold; }

        button.action-btn { background-color: #0984e3; border: none; width: 100%; margin-top: 20px; padding: 12px; font-weight: bold; }
        button.danger { background-color: #d63031; border: none; opacity: 0.8; font-size: 0.8rem; margin-top: 10px;}
        
        /* SHOPPING & FINANCE SIMPLE TABLE */
        table { width: 100%; font-size: 0.9em; border-collapse: collapse; }
        td { padding: 10px 0; border-bottom: 1px solid #eee; }
        .check-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; cursor: pointer; float: right; }
    </style>
</head>
<body>

    <main class="container">
        
        <div id="view-cleaning" class="app-view active">
            <h1>üßº WG Putzplan</h1>

            <div class="highscore-bar">
                <div class="score-item">Alex: <span id="score-alex" class="score-val">0</span></div>
                <div class="score-item">Fred: <span id="score-fred" class="score-val">0</span></div>
            </div>

            <div id="rooms-container">
                <p aria-busy="true">Lade Plan...</p>
            </div>

            <div id="setup-container" style="display:none; text-align:center; margin-top:20px;">
                <button class="primary" onclick="startFresh()">üöÄ Alles Neustarten (Alex=Bad, Fred=K√ºche)</button>
            </div>
        </div>

        <div id="view-shopping" class="app-view">
            <h1>üõí Einkaufsliste</h1>
            <article class="card">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="shop-input" placeholder="Was fehlt?" style="margin-bottom:0;">
                    <button onclick="addShopItem()" style="width:auto; margin-bottom:0;">+</button>
                </div>
                <div id="shopping-list" style="margin-top:20px;"></div>
            </article>
            <article class="card">
                <header>Verlauf</header>
                <ul id="shopping-log" style="font-size:0.8em; color:#666; padding-left:20px; margin-bottom:0;"></ul>
            </article>
        </div>

        <div id="view-finance" class="app-view">
            <h1>üí∞ Finanzen</h1>
            <article class="card">
                <header>Fixkosten</header>
                <div id="cost-list">Lade...</div>
            </article>
        </div>

        <div id="view-stats" class="app-view">
            <h1>‚öôÔ∏è Admin</h1>
            <article class="card">
                <header>Logbuch Putzen</header>
                <div id="cleaning-log" style="font-size:0.8em;"></div>
            </article>
            <details>
                <summary>Admin Tools</summary>
                <button class="danger" onclick="startFresh()">‚ö†Ô∏è ALLES NEUSTARTEN (Reset)</button>
            </details>
        </div>

    </main>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('cleaning', this)">üßπ Putzen</div>
        <div class="nav-item" onclick="switchTab('shopping', this)">üõí</div>
        <div class="nav-item" onclick="switchTab('finance', this)">üí∞</div>
        <div class="nav-item" onclick="switchTab('stats', this)">‚öôÔ∏è</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- NAVIGATION ---
        window.switchTab = (viewId, el) => {
            document.querySelectorAll('.app-view').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            el.classList.add('active');
        };

        // --- LOGIK: PUNKTE ---
        function calculatePoints(daysPassed) {
            if (daysPassed < 4) return 15;
            if (daysPassed < 6) return 10;
            if (daysPassed < 7) return 5;
            if (daysPassed < 8) return 2;
            const overdue = daysPassed - 8;
            return -5 - (overdue * 5); // -5, -10, -15...
        }

        // --- RENDER ROOM CARD ---
        // Das ist das Herzst√ºck: Es zeigt den RAUM, und darin wer zust√§ndig ist.
        function renderRoomCard(roomKey, roomData) {
            const assignee = roomData.assignee;
            const now = new Date();
            const lastCleanedDate = roomData.lastCleaned.toDate();
            const daysPassed = Math.floor((now - lastCleanedDate) / (1000 * 60 * 60 * 24));
            
            const points = calculatePoints(daysPassed);

            let colorClass = "color-good";
            let bgClass = "bg-good";
            let statusText = "Alles gut";
            
            if(daysPassed >= 4) { colorClass = "color-warn"; bgClass = "bg-warn"; statusText = "Zeit l√§uft ab..."; }
            if(daysPassed >= 7) { colorClass = "color-bad"; bgClass = "bg-bad"; statusText = "√úBERF√ÑLLIG!"; }

            let progress = (daysPassed / 7) * 100;
            if(progress > 100) progress = 100;

            const icon = roomKey === "Bad" ? "üõÅ" : "üç≥";
            const roomName = roomKey === "Bad" ? "Das Bad" : "Die K√ºche";

            return `
            <article class="card" style="border-left: 6px solid var(--${colorClass.replace('color-', '')})">
                <div class="room-header">
                    <div class="room-title">
                        <span class="room-icon">${icon}</span> ${roomName}
                    </div>
                    <span class="assignee-badge">üë§ ${assignee}</span>
                </div>

                <div class="deadline ${colorClass}">
                    ${statusText} (Tag ${daysPassed})
                </div>
                <div class="progress-container">
                    <div class="progress-bar ${bgClass}" style="width: ${progress}%"></div>
                </div>

                <button class="action-btn" onclick="finishTask('${roomKey}', '${assignee}', ${points})">
                    ‚úÖ Erledigt (+${points} Pkt)
                </button>
            </article>
            `;
        }

        // --- HAUPTFUNKTION ---
        function loadApp() {
            // Wir nutzen eine neue Collection 'wg_app_v5_independent' damit alles frisch ist
            onSnapshot(doc(db, "wg_app", "wg_app_v5_independent"), (docSnap) => {
                if (!docSnap.exists()) {
                    document.getElementById('rooms-container').innerHTML = "";
                    document.getElementById('setup-container').style.display = 'block';
                    return;
                }
                document.getElementById('setup-container').style.display = 'none';

                const data = docSnap.data();

                // 1. Scores (Oben in der Leiste)
                document.getElementById('score-alex').innerText = data.scores.Alex;
                document.getElementById('score-fred').innerText = data.scores.Fred;

                // 2. Rooms (Bad und K√ºche Kacheln)
                let html = "";
                // Reihenfolge: K√ºche, dann Bad
                if(data.rooms.Kueche) html += renderRoomCard("Kueche", data.rooms.Kueche);
                if(data.rooms.Bad) html += renderRoomCard("Bad", data.rooms.Bad);
                
                document.getElementById('rooms-container').innerHTML = html;

                // 3. Andere Module
                if(data.shopping) renderShopping(data.shopping);
                if(data.finance) renderFinance(data.finance);
                if(data.history) renderHistory(data.history);
            });
        }

        // --- AKTIONEN ---
        window.finishTask = async (roomKey, currentAssignee, points) => {
            const roomName = roomKey === "Kueche" ? "K√ºche" : "Bad";
            if(!confirm(`${currentAssignee} hat ${roomName} geputzt?`)) return;

            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            // 1. Punkte vergeben
            const newScore = data.scores[currentAssignee] + points;
            
            // 2. Tauschpartner (Unabh√§ngig: Wenn Alex fertig, ist Fred dran)
            const nextAssignee = (currentAssignee === "Alex") ? "Fred" : "Alex";

            // 3. Updates
            const updates = {};
            updates[`scores.${currentAssignee}`] = newScore;
            
            // Raum: Neuer Besitzer, Timer Reset
            updates[`rooms.${roomKey}.assignee`] = nextAssignee;
            updates[`rooms.${roomKey}.lastCleaned`] = Timestamp.now();

            // History
            const historyEntry = { 
                txt: `${currentAssignee}: ${roomName} (+${points}) -> Nun: ${nextAssignee}`, 
                date: new Date().toLocaleDateString('de-DE') 
            };
            const newHistory = [historyEntry, ...(data.history || [])];
            updates['history'] = newHistory;

            await updateDoc(docRef, updates);
        };

        // --- EINKAUFSLISTE ---
        function renderShopping(data) {
            let html = "";
            (data.list || []).forEach((item, i) => {
                html += `<tr><td>${item}</td><td><div class="check-btn" onclick="buyItem(${i}, '${item}')">‚úî</div></td></tr>`;
            });
            if((data.list || []).length === 0) html = "<tr><td colspan='2' style='text-align:center; color:#999'>Alles da!</td></tr>";
            document.getElementById('shopping-list').innerHTML = `<table>${html}</table>`;

            let logHtml = "";
            (data.log || []).slice(0,5).forEach(l => logHtml += `<li>${l}</li>`);
            document.getElementById('shopping-log').innerHTML = logHtml;
        }

        window.addShopItem = async () => {
            const val = document.getElementById('shop-input').value;
            if(!val) return;
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            const list = snap.data().shopping.list || [];
            await updateDoc(docRef, { "shopping.list": [...list, val] });
            document.getElementById('shop-input').value = "";
        };

        window.buyItem = async (idx, name) => {
            if(!confirm(`${name} gekauft?`)) return;
            const docRef = doc(db, "wg_app", "wg_app_v5_independent");
            const snap = await getDoc(docRef);
            const data = snap.data();
            const list = [...data.shopping.list];
            list.splice(idx, 1);
            const logEntry = `‚úÖ ${name} gekauft (${new Date().toLocaleDateString('de-DE')})`;
            const newLog = [logEntry, ...(data.shopping.log || [])];
            await updateDoc(docRef, { "shopping.list": list, "shopping.log": newLog });
        };

        // --- FINANZEN ---
        function renderFinance(finance) {
            let html = "<table style='width:100%; font-size:0.9em'>";
            Object.keys(finance.costs || {}).forEach(k => {
                const item = finance.costs[k];
                html += `<tr><td>${k}</td><td style='text-align:right'>${item.val} ‚Ç¨</td></tr>`;
            });
            html += "</table>";
            document.getElementById('cost-list').innerHTML = html;
        }

        // --- HISTORY ---
        function renderHistory(history) {
            if(!history) return;
            let html = "<ul>";
            history.slice(0,10).forEach(h => html += `<li>${h.date}: ${h.txt}</li>`);
            html += "</ul>";
            document.getElementById('cleaning-log').innerHTML = html;
        }

        // --- START FRESH (Initialisierung) ---
        window.startFresh = async () => {
            // HIER IST DIE WICHTIGE √ÑNDERUNG:
            if(!confirm("Alles l√∂schen und neu starten?\n\nAlex -> Bad\nFred -> K√ºche")) return;
            
            const now = Timestamp.now();
            await setDoc(doc(db, "wg_app", "wg_app_v5_independent"), {
                scores: { Alex: 0, Fred: 0 },
                rooms: {
                    // Alex startet im Bad, Fred in der K√ºche
                    Bad: { assignee: "Alex", lastCleaned: now },
                    Kueche: { assignee: "Fred", lastCleaned: now }
                },
                shopping: { list: [], log: [] },
                history: [],
                finance: { 
                    costs: {
                        Miete: { val: 850 }, Strom: { val: 85 }, Internet: { val: 40 }
                    }
                }
            });
            location.reload();
        };

        loadApp();
    </script>
</body>
</html>
