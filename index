<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WG Putz-Commander</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body { padding: 10px; background-color: #11191f; }
        .card { background-color: #1e262e; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .score-display { font-size: 2.5em; font-weight: bold; text-align: center; color: #00d26a; }
        .task-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .deadline { font-size: 0.9em; color: #888; margin-bottom: 10px; }
        
        /* Fortschrittsbalken Design */
        .progress-container { width: 100%; background-color: #333; border-radius: 10px; height: 10px; margin-top: 5px; overflow: hidden; }
        .progress-bar { height: 100%; transition: width 0.5s; }

        /* Farben */
        .color-good { color: #00d26a; }
        .bg-good { background-color: #00d26a; }
        .color-warn { color: #f4a261; }
        .bg-warn { background-color: #f4a261; }
        .color-bad { color: #e76f51; }
        .bg-bad { background-color: #e76f51; }

        h1 { text-align: center; font-size: 1.5rem; margin-bottom: 30px; }
        button.danger { background-color: #e63946; border: none; opacity: 0.7; font-size: 0.8rem; margin-top: 10px;}
    </style>
</head>
<body>

    <main class="container">
        <h1>‚ôæÔ∏è WG Putz-Loop</h1>

        <article class="card">
            <header>üèÜ Highscore</header>
            <div class="grid">
                <div style="text-align: center;">
                    <small>ICH</small>
                    <div id="score-me" class="score-display">-</div>
                </div>
                <div style="text-align: center;">
                    <small>ER</small>
                    <div id="score-him" class="score-display">-</div>
                </div>
            </div>
        </article>

        <div id="task-container">
            <p aria-busy="true">Verbinde mit Datenbank...</p>
        </div>

        <details>
            <summary>Einstellungen</summary>
            <button class="danger" onclick="resetDatabase()">‚ö†Ô∏è Neustart (Reset)</button>
        </details>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, Timestamp } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- DEINE ECHTEN FIREBASE DATEN ---
        const firebaseConfig = {
            apiKey: "AIzaSyDGus88p9qscEFHWbZrTGM3Ja6bgSX4IrQ",
            authDomain: "wg-app-388eb.firebaseapp.com",
            projectId: "wg-app-388eb",
            storageBucket: "wg-app-388eb.firebasestorage.app",
            messagingSenderId: "146563504520",
            appId: "1:146563504520:web:b4c23cd2f09f88788a423d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- PUNKTE REGELN ---
        function calculatePoints(daysPassed) {
            // Tag 1 (0 Tage vergangen) bis Tag 4 (3.99 Tage vergangen)
            if (daysPassed < 4) return 15;
            // Tag 5 bis 6
            if (daysPassed < 6) return 10;
            // Tag 7
            if (daysPassed < 7) return 5;
            // Tag 8
            if (daysPassed < 8) return 2;
            // Tag 9+
            return -5;
        }

        // --- UI RENDERING ---
        function renderUserCard(userId, userName, userData) {
            const lastCleaned = userData.lastCleaned.toDate(); 
            const now = new Date();
            
            // Berechne exakte Tage
            const diffTime = now - lastCleaned;
            const daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const pointsNow = calculatePoints(daysPassed);
            
            // Ampel-Logik
            let statusColor = "color-good";
            let bgColor = "bg-good";
            let statusText = "Alles im gr√ºnen Bereich";

            if(daysPassed >= 4) { statusColor = "color-warn"; bgColor = "bg-warn"; statusText = "Zeit l√§uft ab..."; }
            if(daysPassed >= 7) { statusColor = "color-bad"; bgColor = "bg-bad"; statusText = "√úBERF√ÑLLIG!"; }

            // Fortschrittsbalken
            let progress = (daysPassed / 7) * 100;
            if(progress > 100) progress = 100;

            let html = `<article class="card" style="border-left: 5px solid var(--${statusColor.replace('color-', '')})">`;
            html += `<header style="display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span>üë§ <b>${userName}</b></span>`;
            html += `<span style="font-size:0.8em; opacity:0.7">Seit ${daysPassed} Tagen</span>`;
            html += `</header>`;
            
            html += `<div class="task-title">${userData.currentTask}</div>`;
            html += `<div class="deadline ${statusColor}">${statusText}</div>`;
            
            html += `<div class="progress-container"><div class="progress-bar ${bgColor}" style="width: ${progress}%"></div></div>`;
            
            html += `<div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">`;
            html += `<span>Punkte jetzt: <b class="${statusColor}">${pointsNow}</b></span>`;
            
            html += `<button onclick="window.completeTask('${userId}', ${pointsNow}, '${userData.currentTask}')" style="width:auto; padding:5px 15px; font-size:0.9em; margin-bottom:0;">Erledigt ‚úÖ</button>`;
            html += `</div>`;
            
            html += `</article>`;
            return html;
        }

        // --- HAUPTFUNKTION ---
        function loadDashboard() {
            onSnapshot(doc(db, "wg_app", "state_v2"), (docSnap) => {
                if (!docSnap.exists()) {
                    document.getElementById('task-container').innerHTML = "<p>Datenbank leer. Bitte unten auf 'Neustart' klicken!</p>";
                    return;
                }

                const data = docSnap.data();
                
                document.getElementById('score-me').innerText = data.users.me.score;
                document.getElementById('score-him').innerText = data.users.him.score;

                let html = "";
                html += renderUserCard("me", "ICH", data.users.me);
                html += renderUserCard("him", "ER", data.users.him);
                document.getElementById('task-container').innerHTML = html;
            });
        }

        // --- AKTIONEN ---
        window.completeTask = async (userId, pointsToAdd, currentTaskName) => {
            if(!confirm(`Aufgabe "${currentTaskName}" erledigt? Das gibt ${pointsToAdd} Punkte!`)) return;

            const docRef = doc(db, "wg_app", "state_v2");
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const currentUserData = data.users[userId];
            const nextTask = (currentTaskName === "Bad putzen") ? "K√ºche putzen" : "Bad putzen";
            const newScore = currentUserData.score + pointsToAdd;

            const newUserData = {
                score: newScore,
                currentTask: nextTask,
                lastCleaned: Timestamp.now() 
            };

            await updateDoc(docRef, {
                [`users.${userId}`]: newUserData
            });
        };

        // --- DATABASE INIT ---
        async function initDatabase() {
            console.log("Erstelle Datenbank Struktur...");
            await setDoc(doc(db, "wg_app", "state_v2"), {
                users: {
                    me: { score: 0, currentTask: "Bad putzen", lastCleaned: Timestamp.now() },
                    him: { score: 0, currentTask: "K√ºche putzen", lastCleaned: Timestamp.now() }
                }
            });
        }

        window.resetDatabase = async () => {
            if(confirm("Alles auf Anfang setzen?")) {
                await initDatabase();
                location.reload();
            }
        }

        loadDashboard();
    </script>
</body>
</html>
